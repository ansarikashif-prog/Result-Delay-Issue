<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Report Result Delay ‚Äî JMI CDOE</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">

<style>
  /* ---------- Mobile-first theme ---------- */
  :root{
    --accent:#2563EB; --accent-2:#1E40AF; --bg:#f7f8fa; --card:#ffffff; --muted:#475569;
    --border:#e6eefc; --shadow:0 12px 36px rgba(16,24,40,0.06); --radius:14px; --btn:#0a255e;
    --danger:#ef4444;
  }

  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#071029;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{max-width:980px;margin:14px auto;padding:14px;box-sizing:border-box;}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);border:1px solid var(--border);}

  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .title h1{font-family:"Plus Jakarta Sans",Inter,sans-serif;margin:0;font-size:1.1rem;color:var(--accent);}
  .subtitle{color:var(--muted);font-size:13px;margin-top:6px;}

  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px;}
  @media(min-width:880px){ .grid{grid-template-columns:1fr 420px;} }

  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media(max-width:720px){ .form-grid{grid-template-columns:1fr;} }

  label{display:block;font-size:13px;color:var(--muted);font-weight:700;margin-bottom:6px;}
  input,textarea,select{width:100%;padding:11px;border-radius:10px;border:1px solid var(--border);font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff);color:#071029;box-sizing:border-box;}
  textarea{min-height:180px;resize:vertical;line-height:1.6;font-family:Inter,system-ui;}
  .muted{font-size:13px;color:var(--muted);}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
  .btn{background:var(--btn);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;box-shadow:0 10px 28px rgba(2,6,23,0.08);display:inline-flex;align-items:center;gap:10px;}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(6,24,44,0.04);box-shadow:none;}
  .btn.secondary{background:linear-gradient(180deg,#fff,#fbfdff);color:var(--btn);border:1px solid var(--border);font-weight:700;}
  .small{font-size:13px;color:var(--muted);}
  .note{text-align:center;color:var(--muted);font-size:13px;margin-top:10px;}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px;}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(37,99,235,0.06);color:var(--accent);font-weight:700;font-size:13px;box-shadow:0 6px 18px rgba(15,23,42,0.04);}

  /* language toggle full button */
  .lang-toggle { display:inline-flex; gap:6px; align-items:center; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:linear-gradient(180deg,#fff,#fbfdff); cursor:pointer; }
  .lang-toggle button { background:transparent; border:0; font-weight:700; cursor:pointer; padding:6px 10px; border-radius:8px; }
  .lang-toggle button.active { background: linear-gradient(180deg,var(--accent-2),var(--accent)); color:#fff; box-shadow:0 8px 20px rgba(37,99,235,0.12); }

  /* spinner */
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.22);border-top-color:#fff;animation:spin .7s linear infinite;display:inline-block}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* subtle success animation */
  .success-pop { transform: translateY(-6px); transition: transform .18s ease; }

  /* accessibility focus */
  input:focus, textarea:focus, button:focus { outline: 3px solid rgba(37,99,235,0.12); outline-offset:2px; }

  @media (max-width:420px){
    .title h1{font-size:1rem;}
    .card{padding:12px;}
    .wrap{padding:10px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="main-title">
      <header>
        <div class="title">
          <h1 id="main-title">Report: Delay in 2nd-Year Result ‚Äî BA (ODL)</h1>
          <div class="subtitle">Exams finished on <strong>24 Aug 2025</strong>. Send an individual email to the programme coordinator.</div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div style="display:flex;gap:8px;align-items:center">
          </div>

          <div class="badge" id="daysBadge">üóìÔ∏è Days since exam: --</div>
          <div class="badge" id="totalBadge">Total submissions: 0</div>
        </div>
      </header>

      <div class="grid" aria-live="polite">
        <!-- Form -->
        <section class="card" aria-label="Form panel" style="padding:12px;">
          <form id="reportForm" autocomplete="on" onsubmit="return false;">
            <div class="form-grid">
              <div>
                <label for="name">Full Name *</label>
                <input id="name" name="name" type="text" autocomplete="name" placeholder="e.g. Zainab" required />
              </div>

              <div>
                <label for="roll">Roll No *</label>
                <input id="roll" name="roll" type="text" placeholder="e.g. D23BA0000" required />
                <div id="rollHint" class="small muted" style="margin-top:6px">Format: Alphanumeric, 5‚Äì16 chars (auto uppercased)</div>
              </div>

              <div>
                <label for="enroll">Enrollment No *</label>
                <input id="enroll" name="enroll" type="text" placeholder="e.g. 23-123456" required />
              </div>

              <div>
                <label for="contact">Contact Number <span class="small">(recommended)</span></label>
                <input id="contact" name="contact" type="tel" placeholder="+91 98xxxxxxx" inputmode="tel" />
              </div>
            </div>

            <div class="controls" id="formHint" style="margin-top:12px">
              <div style="flex:1" aria-hidden="true"></div>
              <div class="muted">Tip: preview appears automatically. Edit it before sending.</div>
            </div>
          </form>
        </section>
        <!-- Language toggle full button -->
            <div class="lang-toggle" role="group" aria-label="Choose language">
              <button id="btnEng" class="active" aria-pressed="true">English</button>
              <button id="btnHin" aria-pressed="false">Hinglish</button>
            </div>

        <!-- Preview & actions -->
        <aside class="card" aria-label="Preview and actions" style="padding:12px;">
          <label for="preview">Email preview</label>
          <textarea id="preview" spellcheck="true" aria-label="Email preview">Please enter Full Name, Roll No and Enrollment No to auto-generate a personalised email preview.</textarea>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <div style="display:flex;gap:8px;align-items:center">
              <button id="rewriteBtn" class="btn ghost" title="Get a different wording">‚Üª Rewrite</button>
              <div class="small muted">You can edit the preview before sending.</div>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <div id="charNote" class="muted" style="visibility:hidden">Length: <span id="charCount">0</span></div>
            </div>
          </div>

          <div style="display:flex;justify-content:center;margin-top:12px">
            <button id="sendBtn" class="btn" aria-live="polite" aria-label="Send My Concern">
              <span id="btnSpinner" style="display:none" class="spinner" aria-hidden="true"></span>
              <span id="btnText">Send</span>
            </button>
          </div>

          <div class="note" id="statusNote">The preview opens automatically as you enter details.</div>
          <div class="muted" style="text-align:center;margin-top:6px">By sending, minimal metadata (time, roll, contact if provided) will be stored for follow-up.</div>
        </aside>
      </div>

      <footer>System for student assistance ‚Äî use responsibly.</footer>
    </div>

    <!-- toast -->
    <div id="toast" style="position:fixed;right:18px;bottom:18px;background:#0b1220;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 14px 36px rgba(2,6,23,0.12);opacity:0;transform:translateY(10px);transition:opacity .18s,transform .18s;z-index:9999">...</div>
  </div>

<script type="module">
/* =========================
  CONFIG / TOGGLE
  =========================
  - INCLUDE_PHONE_IN_MAIL (hard-coded):
      true  -> contact will be included inside the mailto body
      false -> contact will NOT be added to the mailto body (but will be saved in DB)
*/
let INCLUDE_PHONE_IN_MAIL = true; // <- edit here for behavior

/* =========================
   Firebase (v11 modular) imports
   =========================
   Note: You already had Firebase config. Keep these lines if using Firestore.
   If you don't use Firestore, you can remove those parts and all DB calls (addDoc/onSnapshot/serverTimestamp).
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* =========================
   Import templates (separate file, same folder)
   Make sure templates.js is served alongside index.html
*/
import { templatesEnglish, templatesHinglish } from './templates.js';

/* ============== FIREBASE CONFIG ============== */
const firebaseConfig = {
  apiKey: "AIzaSyCt0mvu4CbRQBdBJL5wAxijAdEirBUDCDc",
  authDomain: "justice-for-jmi.firebaseapp.com",
  projectId: "justice-for-jmi",
  storageBucket: "justice-for-jmi.firebasestorage.app",
  messagingSenderId: "17849710989",
  appId: "1:17849710989:web:0b1dd3c9bb77520d98a5c4"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const COLLECTION_NAME = "resultdelayreport";
const submissionsCol = collection(db, COLLECTION_NAME);

/* =========================
   DOM refs & state
*/
const nameEl = document.getElementById('name');
const rollEl = document.getElementById('roll');
const enrollEl = document.getElementById('enroll');
const contactEl = document.getElementById('contact');
const previewEl = document.getElementById('preview');
const rewriteBtn = document.getElementById('rewriteBtn');
const sendBtn = document.getElementById('sendBtn');
const daysBadge = document.getElementById('daysBadge');
const totalBadge = document.getElementById('totalBadge');
const statusNote = document.getElementById('statusNote');
const toastEl = document.getElementById('toast');
const charNote = document.getElementById('charNote');
const charCount = document.getElementById('charCount');
const btnSpinner = document.getElementById('btnSpinner');
const btnText = document.getElementById('btnText');
const rollHint = document.getElementById('rollHint');

const btnEng = document.getElementById('btnEng');
const btnHin = document.getElementById('btnHin');

let currentLang = localStorage.getItem('rd_lang') || 'en';
let currentIndex = null;
let userEdited = false;
let lastSendAt = 0;
const RATE_LIMIT_MS = 10000;
const MAILTO_BODY_THRESHOLD = 1900;
let unsubSnapshot = null;

/* =========================
   Utilities
*/
function daysSinceExam(){
  const examLocal = new Date(2025,7,24); // Aug 24 2025
  const now = new Date();
  const diff = Math.floor((now - examLocal) / (1000*60*60*24));
  return diff >= 0 ? diff : 0;
}
function escapeHtml(str){ return String(str || '').replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'}[s])); }
function pickIndex(arrLen, prev){ if (!arrLen) return 0; if (arrLen===1) return 0; let idx; do{ idx = Math.floor(Math.random()*arrLen); } while(idx===prev); return idx; }
function readableTimestamp(){ const now=new Date(); const d=now.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); const t=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}); return `${d} ‚Äî ${t}`; }

/* =========================
   Init UI
*/
function initUI(){
  // set language UI
  applyLangUI();

  daysBadge.textContent = `üóìÔ∏è Days since exam: ${daysSinceExam()}`;
  setInterval(()=>{ daysBadge.textContent = `üóìÔ∏è Days since exam: ${daysSinceExam()}`; }, 1000*60*60);

  // restore draft
  const draft = JSON.parse(localStorage.getItem('rd_draft_final') || '{}');
  if (draft.name) nameEl.value = draft.name;
  if (draft.roll) rollEl.value = draft.roll;
  if (draft.enroll) enrollEl.value = draft.enroll;
  if (draft.contact) contactEl.value = draft.contact;

  // roll hint initial state
  formatRollInput();

  generatePreviewAuto();
  setupRealtimeCounter();
  autoResizePreview();
  updateCharCount();
}

/* =========================
   Language toggle: full button behaviour (persist)
*/
function applyLangUI(){
  if (currentLang === 'hi'){
    btnHin.classList.add('active'); btnHin.setAttribute('aria-pressed','true');
    btnEng.classList.remove('active'); btnEng.setAttribute('aria-pressed','false');
  } else {
    btnEng.classList.add('active'); btnEng.setAttribute('aria-pressed','true');
    btnHin.classList.remove('active'); btnHin.setAttribute('aria-pressed','false');
  }
  localStorage.setItem('rd_lang', currentLang);
}
// language click handlers
btnEng.addEventListener('click', ()=>{ if (currentLang === 'en') return; currentLang = 'en'; applyLangUI(); regenerateIfReady(); });
btnHin.addEventListener('click', ()=>{ if (currentLang === 'hi') return; currentLang = 'hi'; applyLangUI(); regenerateIfReady(); });

/* =========================
   Realtime counter
*/
function setupRealtimeCounter(){
  try {
    unsubSnapshot = onSnapshot(submissionsCol, snap => {
      totalBadge.textContent = `Total submissions: ${snap.size}`;
    }, err => { console.warn('onSnapshot error', err); });
  } catch(e){
    console.warn('setupRealtimeCounter error', e);
  }
  window.addEventListener('beforeunload', ()=>{ try{ if (typeof unsubSnapshot === 'function') unsubSnapshot(); }catch(e){} });
}

/* =========================
   Fill templates
*/
function fillTemplateByLang(idx, lang, name, roll, enroll){
  const arr = (lang === 'hi') ? templatesHinglish : templatesEnglish;
  const safeName = escapeHtml(name || '');
  const safeRoll = escapeHtml(roll || '');
  const safeEnroll = escapeHtml(enroll || '');
  let text = (arr[idx % arr.length] || arr[0])
    .replaceAll('[NAME]', safeName)
    .replaceAll('[ROLL]', safeRoll)
    .replaceAll('[ENROLL]', safeEnroll);
  return text;
}

/* =========================
   Smart auto-generate preview
*/
let debounceTimer = null;
function generatePreviewAuto(){
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(()=>{
    const name = nameEl.value.trim();
    const roll = rollEl.value.trim();
    const enroll = enrollEl.value.trim();
    const contact = contactEl.value.trim();
    if (!name || !roll || !enroll){
      if (!userEdited) { previewEl.value = "Please enter Full Name, Roll No and Enrollment No to auto-generate a personalised email preview."; autoResizePreview(); updateCharCount(); }
      return;
    }
    if (userEdited) { updateCharCount(); return; }
    const arrLen = (currentLang === 'hi') ? templatesHinglish.length : templatesEnglish.length;
    currentIndex = pickIndex(arrLen, currentIndex);
    const base = fillTemplateByLang(currentIndex, currentLang, name, roll, enroll);
    previewEl.value = contact ? `${base}\nContact: ${escapeHtml(contact)}` : base;
    updateCharCount();
    autoResizePreview();
  }, 180);
}

/* =========================
   Bind inputs & autosave
*/
[nameEl, rollEl, enrollEl, contactEl].forEach(el=>{
  el.addEventListener('input', ()=>{ userEdited=false; autosaveDraft(); if (el===rollEl) formatRollInput(); generatePreviewAuto(); });
  el.addEventListener('paste', ()=> setTimeout(()=>{ userEdited=false; autosaveDraft(); if (el===rollEl) formatRollInput(); generatePreviewAuto(); }, 30));
});
previewEl.addEventListener('input', ()=>{ userEdited=true; updateCharCount(); autosaveDraft(); autoResizePreview(); });

function autosaveDraft(){
  const draft = { name:nameEl.value.trim(), roll:rollEl.value.trim(), enroll:enrollEl.value.trim(), contact:contactEl.value.trim(), lang: currentLang };
  try{ localStorage.setItem('rd_draft_final', JSON.stringify(draft)); } catch(e){}
}
function updateCharCount(){ const len = previewEl.value ? previewEl.value.length : 0; charCount.textContent = len; if (len > MAILTO_BODY_THRESHOLD){ charNote.style.visibility='visible'; charNote.textContent = `Length: ${len} (long ‚Äî clipboard fallback)`; } else { charNote.style.visibility='hidden'; } }

/* =========================
   Roll formatting + hint
*/
function formatRollInput(){
  let v = rollEl.value || '';
  v = v.toUpperCase().replace(/\s+/g,'');
  rollEl.value = v;
  const clean = v.replace(/\s+/g,'');
  if (!/^[A-Z0-9\-]{5,16}$/.test(clean)){
    rollHint.textContent = 'Roll looks unusual. Use 5‚Äì16 alphanumeric characters (hyphen allowed).';
    rollHint.style.color = 'var(--danger)';
  } else {
    rollHint.textContent = 'Format: Alphanumeric, 5‚Äì16 chars (auto uppercased)';
    rollHint.style.color = 'var(--muted)';
  }
}

/* =========================
   Rewrite button
*/
rewriteBtn.addEventListener('click', ()=>{
  const name = nameEl.value.trim(), roll = rollEl.value.trim(), enroll = enrollEl.value.trim(), contact = contactEl.value.trim();
  if (!name||!roll||!enroll){ alert('Please fill Full Name, Roll No and Enrollment No first.'); return; }
  const arrLen = (currentLang==='hi')?templatesHinglish.length:templatesEnglish.length;
  currentIndex = pickIndex(arrLen, currentIndex);
  previewEl.style.opacity = '0.35';
  setTimeout(()=>{ const base = fillTemplateByLang(currentIndex,currentLang,name,roll,enroll); previewEl.value = contact ? `${base}\nContact: ${escapeHtml(contact)}` : base; previewEl.style.opacity='1'; userEdited=false; autosaveDraft(); updateCharCount(); autoResizePreview(); }, 140);
});

/* =========================
   Validation (contact optional)
*/
function validateForm(){
  const name = nameEl.value.trim();
  const roll = rollEl.value.trim();
  const enroll = enrollEl.value.trim();
  const contact = contactEl.value.trim();
  if (name.length < 2 || name.length > 60) return { ok:false, msg:'Name must be between 2 and 60 characters.' };
  const rollClean = roll.replace(/\s+/g,'');
  if (!/^[A-Za-z0-9\-]{5,16}$/.test(rollClean)) return { ok:false, msg:'Roll No should be 5‚Äì16 characters, alphanumeric (hyphen allowed). Example: D23BA0000' };
  const enrollClean = enroll.replace(/\s+/g,'');
  if (enrollClean.length < 4 || enrollClean.length > 32) return { ok:false, msg:'Enrollment No seems invalid. Example: 23-123456' };
  if (contact){
    const ph = contact.replace(/[ \-()]/g,'');
    if (!/^\+?[0-9]{7,15}$/.test(ph)) return { ok:false, msg:'Contact number appears invalid. Use digits, optionally +, 7‚Äì15 digits.' };
  }
  return { ok:true };
}

/* =========================
   Send flow (uses INCLUDE_PHONE_IN_MAIL)
*/
async function handleSend(){
  const now = Date.now();
  if (now - lastSendAt < RATE_LIMIT_MS){ showToast('Please wait a moment before sending again.'); return; }
  const v = validateForm();
  if (!v.ok){ alert(v.msg); return; }

  const name = nameEl.value.trim();
  const roll = rollEl.value.trim();
  const enroll = enrollEl.value.trim();
  const contact = contactEl.value.trim();

  // Build mail body from preview but control contact inclusion
  let previewText = previewEl.value && previewEl.value.trim().length>0 ? previewEl.value.trim() : fillTemplateByLang(currentIndex ?? 0, currentLang, name, roll, enroll);
  const lines = previewText.split(/\r?\n/);
  if (/^Contact:/i.test(lines[lines.length-1].trim())) lines.pop();
  const baseBody = lines.join('\n').trim();

  const mailBody = (INCLUDE_PHONE_IN_MAIL && contact) ? `${baseBody}\nContact: ${contact}` : baseBody;
  const savedBody = contact ? `${baseBody}\nContact: ${contact}` : baseBody;

  enterSpinner();
  statusNote.textContent = 'Saving your submission...';

  const docData = {
    name,
    roll,
    enrollment: enroll,
    contact: contact || null,
    language: currentLang === 'hi' ? 'hinglish' : 'english',
    templateIndex: currentIndex ?? 0,
    mailBody: savedBody,
    readableTime: readableTimestamp(),
    ts: serverTimestamp()
  };

  try {
    await addDoc(submissionsCol, docData);
    statusNote.textContent = 'Saved. Preparing your mail...';

    const to = 'g.mgaffar@jmi.ac.in';
    const bcc = 'mrizvi@jmi.ac.in';
    const subject = 'Regarding Delay in Declaration of BA ODL 2nd-Year Results';
    const subjectEnc = encodeURIComponent(subject);
    const bodyEnc = encodeURIComponent(mailBody);
    const mailto = `mailto:${encodeURIComponent(to)}?bcc=${encodeURIComponent(bcc)}&subject=${subjectEnc}&body=${bodyEnc}`;

    // small UX delay
    await new Promise(r=>setTimeout(r,420));

    if (bodyEnc.length > MAILTO_BODY_THRESHOLD){
      // long -> copy to clipboard and open short mail window
      try {
        await navigator.clipboard.writeText(mailBody);
        const shortBody = encodeURIComponent('Dear Sir,\n\nI have prepared a message and copied it to my clipboard. Please paste it into the email body and send.\n\nRegards,\n');
        const mailtoShort = `mailto:${encodeURIComponent(to)}?bcc=${encodeURIComponent(bcc)}&subject=${subjectEnc}&body=${shortBody}`;
        window.location.href = mailtoShort;
        showToast('Message copied to clipboard. Mail window opened ‚Äî paste & send.');
      } catch (copyErr){
        console.warn('clipboard failed', copyErr);
        window.location.href = mailto;
        showToast('Mail window opened. If body missing, paste message manually.');
      }
    } else {
      // open mail normally
      window.location.href = mailto;
      showToast('Mail window opened. Please send the message from your mail app.');
    }

    lastSendAt = Date.now();
    setTimeout(()=>{ smallSuccess(); showToast('Saved & mail window opened.'); }, 300);
  } catch (err) {
    console.error('Save error', err);
    alert('There was an error saving your submission. Please try again.');
    showToast('Save failed. Try again.');
  } finally {
    exitSpinner();
    statusNote.textContent = 'If your mail app did not open, allow pop-ups or try again.';
  }
}

/* =========================
   Spinner & small success
*/
function enterSpinner(){ sendBtn.setAttribute('disabled','true'); btnSpinner.style.display='inline-block'; btnText.style.opacity='0'; }
function exitSpinner(){ sendBtn.removeAttribute('disabled'); btnSpinner.style.display='none'; btnText.style.opacity='1'; }
let toastTimer = null;
function showToast(msg, timeout=3000){ toastEl.textContent = msg; toastEl.style.opacity='1'; toastEl.style.transform='none'; clearTimeout(toastTimer); toastTimer = setTimeout(()=>{ toastEl.style.opacity='0'; toastEl.style.transform='translateY(10px)'; }, timeout); }
function smallSuccess(){ const c = document.querySelector('.card'); c.classList.add('success-pop'); setTimeout(()=>c.classList.remove('success-pop'), 360); }

/* =========================
   Auto resize preview + accessibility
*/
function autoResizePreview(){ previewEl.style.height = 'auto'; const maxH = Math.min(window.innerHeight * 0.6, 1200); previewEl.style.height = Math.min(previewEl.scrollHeight + 8, maxH) + 'px'; }
previewEl.addEventListener('input', autoResizePreview); window.addEventListener('resize', autoResizePreview);
// Ctrl+Enter to send
previewEl.addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.key === 'Enter'){ e.preventDefault(); handleSend(); } });

/* =========================
   Regenerate if ready (language change)
*/
function regenerateIfReady(){
  const n = nameEl.value.trim(), r = rollEl.value.trim(), e = enrollEl.value.trim(), c = contactEl.value.trim();
  if (n && r && e){
    currentIndex = pickIndex((currentLang==='hi')?templatesHinglish.length:templatesEnglish.length, currentIndex);
    const base = fillTemplateByLang(currentIndex, currentLang, n, r, e);
    previewEl.value = c ? `${base}\nContact: ${escapeHtml(c)}` : base;
    userEdited = false; autosaveDraft(); updateCharCount(); autoResizePreview();
  }
}

/* =========================
   Optional: backend-controlled toggle (Fetch flag from Firestore)
   - If you prefer controlling INCLUDE_PHONE_IN_MAIL from Firestore, uncomment below and create doc at:
     collection: 'config'  doc: 'emailSettings'  fields: { includePhoneInMail: true/false }
*/
async function fetchIncludePhoneFlagFromFirestore(){
  try {
    const cfgRef = doc(db, 'config', 'emailSettings');
    const snap = await getDoc(cfgRef);
    if (snap.exists()){
      const data = snap.data();
      if (typeof data.includePhoneInMail === 'boolean'){
        INCLUDE_PHONE_IN_MAIL = data.includePhoneInMail;
      }
    }
  } catch(err){
    console.warn('Could not fetch includePhoneInMail from Firestore', err);
  }
}

/* =========================
   Event bindings & init
*/
document.addEventListener('DOMContentLoaded', initUI);
sendBtn.addEventListener('click', handleSend);

</script>
</body>
</html>
